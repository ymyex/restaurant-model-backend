<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üçï Simple Pizza - Admin Control Panel</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.32.2/ace.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=Fira+Code:wght@300;400;500&display=swap');
        
        body {
            font-family: 'Inter', sans-serif;
        }
        
        .code-font {
            font-family: 'Fira Code', monospace;
        }
        
        .cyber-grid {
            background-image: 
                linear-gradient(rgba(56, 189, 248, 0.1) 1px, transparent 1px),
                linear-gradient(90deg, rgba(56, 189, 248, 0.1) 1px, transparent 1px);
            background-size: 20px 20px;
        }
        
        .holographic-card {
            background: linear-gradient(135deg, 
                rgba(255, 255, 255, 0.1), 
                rgba(255, 255, 255, 0.05),
                rgba(255, 255, 255, 0.1));
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.15);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }
        
        .neon-glow {
            box-shadow: 0 0 20px rgba(56, 189, 248, 0.4);
        }
        
        .status-indicator {
            position: relative;
            overflow: hidden;
        }
        
        .status-indicator::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            animation: shimmer 2s infinite;
        }
        
        @keyframes shimmer {
            0% { left: -100%; }
            100% { left: 100%; }
        }
        
        .pulse-ring {
            animation: pulse-ring 2s cubic-bezier(0.455, 0.03, 0.515, 0.955) infinite;
        }
        
        @keyframes pulse-ring {
            0% { transform: scale(0.33); }
            80%, 100% { transform: scale(1); opacity: 0; }
        }
        
        .gradient-text {
            background: linear-gradient(135deg, #38bdf8, #a855f7, #ec4899);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .function-card {
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .function-card:hover {
            transform: translateY(-4px) scale(1.02);
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.4);
        }
        
        .floating-action {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            z-index: 50;
        }
        
        .editor-container {
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .tab-button {
            transition: all 0.3s ease;
            border-radius: 0.75rem;
            position: relative;
            overflow: hidden;
            margin: 0 0.25rem;
            padding: 0.75rem 1.5rem;
        }
        
        .tab-button.active {
            background: linear-gradient(135deg, #38bdf8, #a855f7);
            color: white;
            border-radius: 0.75rem;
            box-shadow: 0 4px 20px rgba(56, 189, 248, 0.3);
            border-bottom: none !important;
        }
        
        .tab-button:not(.active):hover {
            background: rgba(56, 189, 248, 0.1);
            border-radius: 0.75rem;
        }
    </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-gray-900 via-blue-900 to-purple-900 cyber-grid">
    <!-- Navigation Bar -->
    <nav class="holographic-card border-b border-gray-700 sticky top-0 z-40">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex items-center justify-between h-16">
                <!-- Logo and Title -->
                <div class="flex items-center space-x-4">
                    <div class="flex items-center space-x-3">
                        <div class="relative">
                            <div class="w-10 h-10 bg-gradient-to-r from-orange-500 to-red-500 rounded-lg flex items-center justify-center">
                                <i data-lucide="pizza" class="w-6 h-6 text-white"></i>
                            </div>
                            <div class="absolute -top-1 -right-1 w-4 h-4 bg-green-500 rounded-full pulse-ring"></div>
                            <div class="absolute -top-1 -right-1 w-4 h-4 bg-green-500 rounded-full"></div>
                        </div>
                        <div>
                            <h1 class="text-2xl font-bold gradient-text">Simple Pizza</h1>
                            <p class="text-xs text-gray-400">Voice AI Control Panel</p>
                        </div>
                    </div>
                </div>
                
                <!-- Status and Actions -->
                <div class="flex items-center space-x-4">
                    <div class="status-indicator bg-green-500/20 text-green-400 px-3 py-1 rounded-full text-sm font-medium">
                        <i data-lucide="circle" class="w-3 h-3 inline mr-1 fill-current"></i>
                        System Online
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <!-- Stats Overview -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
            <div class="holographic-card rounded-xl p-6 border-l-4 border-blue-500">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-blue-400 text-sm font-medium">AI Functions</p>
                        <p id="functionsCount" class="text-3xl font-bold text-white">0</p>
                    </div>
                    <div class="bg-blue-500/20 p-3 rounded-full">
                        <i data-lucide="zap" class="w-6 h-6 text-blue-400"></i>
                    </div>
                </div>
            </div>
            
            <div class="holographic-card rounded-xl p-6 border-l-4 border-green-500">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-green-400 text-sm font-medium">Voice Model</p>
                        <p id="voiceModel" class="text-lg font-semibold text-white">GPT-4o Realtime</p>
                    </div>
                    <div class="bg-green-500/20 p-3 rounded-full">
                        <i data-lucide="mic" class="w-6 h-6 text-green-400"></i>
                    </div>
                </div>
            </div>
            
            <div class="holographic-card rounded-xl p-6 border-l-4 border-purple-500">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-purple-400 text-sm font-medium">Prompt Length</p>
                        <p id="promptLength" class="text-2xl font-bold text-white">0</p>
                        <p class="text-xs text-gray-400">characters</p>
                    </div>
                    <div class="bg-purple-500/20 p-3 rounded-full">
                        <i data-lucide="file-text" class="w-6 h-6 text-purple-400"></i>
                    </div>
                </div>
            </div>
            
            <div class="holographic-card rounded-xl p-6 border-l-4 border-yellow-500">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-yellow-400 text-sm font-medium">Last Updated</p>
                        <p id="lastUpdated" class="text-sm font-medium text-white">Never</p>
                    </div>
                    <div class="bg-yellow-500/20 p-3 rounded-full">
                        <i data-lucide="clock" class="w-6 h-6 text-yellow-400"></i>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Tabs -->
        <div class="holographic-card rounded-xl overflow-hidden mb-8">
            <div class="border-b border-gray-700 bg-gray-800/50">
                <nav class="flex space-x-4 px-6 py-2" role="tablist">
                    <button class="tab-button font-medium text-sm active" data-tab="prompt-tab">
                        <i data-lucide="edit-3" class="w-4 h-4 inline mr-2"></i>
                        System Prompt Editor
                    </button>
                    <button class="tab-button font-medium text-sm text-gray-400 hover:text-gray-300" data-tab="functions-tab">
                        <i data-lucide="cpu" class="w-4 h-4 inline mr-2"></i>
                        AI Functions
                    </button>
                    <button class="tab-button font-medium text-sm text-gray-400 hover:text-gray-300" data-tab="menu-tab">
                        <i data-lucide="pizza" class="w-4 h-4 inline mr-2"></i>
                        Menu Data
                    </button>
                    <button class="tab-button font-medium text-sm text-gray-400 hover:text-gray-300" data-tab="settings-tab">
                        <i data-lucide="settings" class="w-4 h-4 inline mr-2"></i>
                        Settings
                    </button>
                </nav>
            </div>

            <!-- Prompt Editor Tab -->
            <div id="prompt-tab" class="tab-content active p-6">
                <div class="flex items-center justify-between mb-6">
                    <div>
                        <h2 class="text-2xl font-bold text-white mb-2">AI System Prompt</h2>
                        <p class="text-gray-400">Configure how the AI assistant behaves and responds to customers</p>
                    </div>
                    <div class="flex space-x-3">
                        <button id="resetPromptButton" class="bg-gray-600/20 hover:bg-gray-600/30 text-gray-300 hover:text-white px-4 py-2 rounded-lg transition-colors flex items-center space-x-2">
                            <i data-lucide="refresh-cw" class="w-4 h-4"></i>
                            <span>Reset to Default</span>
                        </button>
                        <button id="savePromptButton" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-lg transition-colors flex items-center space-x-2 neon-glow">
                            <i data-lucide="save" class="w-4 h-4"></i>
                            <span>Save Changes</span>
                        </button>
                    </div>
                </div>
                
                <div class="editor-container">
                    <div id="promptEditor" class="min-h-96"></div>
                </div>
                
                <div class="mt-4 p-4 bg-blue-500/10 border border-blue-500/20 rounded-lg">
                    <div class="flex items-start space-x-3">
                        <i data-lucide="info" class="w-5 h-5 text-blue-400 mt-0.5"></i>
                        <div class="text-sm text-blue-300">
                            <p class="font-medium mb-1">Prompt Engineering Tips:</p>
                            <ul class="list-disc list-inside space-y-1 text-blue-200">
                                <li>Be specific about the restaurant's personality and tone</li>
                                <li>Include clear instructions for function calling requirements</li>
                                <li>Specify how to handle edge cases and errors</li>
                                <li>Define the order confirmation process clearly</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Functions Tab -->
            <div id="functions-tab" class="tab-content p-6">
                <div class="flex items-center justify-between mb-6">
                    <div>
                        <h2 class="text-2xl font-bold text-white mb-2">AI Function Capabilities</h2>
                        <p class="text-gray-400">Available functions that the AI can call to process orders</p>
                    </div>
                    <div class="bg-blue-500/20 text-blue-300 px-4 py-2 rounded-lg flex items-center space-x-2">
                        <i data-lucide="edit-3" class="w-4 h-4"></i>
                        <span class="font-medium">Click a card to edit</span>
                    </div>
                </div>
                
                <div id="functionsGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <!-- Functions will be loaded here -->
                </div>
            </div>

            <!-- Menu Data Tab -->
            <div id="menu-tab" class="tab-content p-6">
                <div class="flex flex-wrap items-center justify-between gap-4 mb-6">
                    <div>
                        <h2 class="text-2xl font-bold text-white mb-2">Menu Data</h2>
                        <p class="text-gray-400">Update pizzas, appetizers, drinks, desserts, and toppings in one place</p>
                    </div>
                    <div class="flex items-center gap-3">
                        <button id="resetMenuButton" class="bg-gray-600/20 hover:bg-gray-600/30 text-gray-300 hover:text-white px-4 py-2 rounded-lg transition-colors flex items-center space-x-2">
                            <i data-lucide="refresh-ccw" class="w-4 h-4"></i>
                            <span>Reset to Default</span>
                        </button>
                        <button id="saveMenuButton" class="bg-emerald-600 hover:bg-emerald-700 text-white px-6 py-2 rounded-lg transition-colors flex items-center space-x-2 neon-glow">
                            <i data-lucide="save" class="w-4 h-4"></i>
                            <span>Save Menu</span>
                        </button>
                    </div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
                    <div class="holographic-card rounded-lg p-6">
                        <div class="flex items-center space-x-3 mb-3">
                            <div class="bg-blue-500/20 text-blue-300 p-2 rounded-lg">
                                <i data-lucide="info" class="w-5 h-5"></i>
                            </div>
                            <h3 class="text-white font-semibold text-lg">How it works</h3>
                        </div>
                        <p class="text-gray-300 text-sm">Edit the JSON schema to update menu items. Each category (<span class="text-white">pizzas, appetizers, drinks, desserts</span>) must be an array of objects with <span class="text-white">itemId</span> and <span class="text-white">name</span>. Include <span class="text-white">prices</span> or <span class="text-white">price</span> fields as needed.</p>
                    </div>
                    <div class="holographic-card rounded-lg p-6">
                        <div class="flex items-center space-x-3 mb-3">
                            <div class="bg-purple-500/20 text-purple-300 p-2 rounded-lg">
                                <i data-lucide="sparkles" class="w-5 h-5"></i>
                            </div>
                            <h3 class="text-white font-semibold text-lg">Live updates</h3>
                        </div>
                        <p class="text-gray-300 text-sm">Changes take effect immediately for the AI assistant and function handlers. Use reset to restore the built-in sample data.</p>
                    </div>
                    <div class="holographic-card rounded-lg p-6">
                        <div class="flex items-center space-x-3 mb-3">
                            <div class="bg-emerald-500/20 text-emerald-300 p-2 rounded-lg">
                                <i data-lucide="shield" class="w-5 h-5"></i>
                            </div>
                            <h3 class="text-white font-semibold text-lg">Validation</h3>
                        </div>
                        <p class="text-gray-300 text-sm">We validate that all categories and the toppings array exist before saving. Any JSON errors will be surfaced below the editor.</p>
                    </div>
                </div>

                <div class="editor-container mb-4">
                    <div id="menuEditor" class="min-h-[28rem]"></div>
                </div>
                <p id="menuEditorError" class="hidden text-sm text-red-300 bg-red-500/10 border border-red-500/30 rounded-lg px-3 py-2"></p>
            </div>

            <!-- Settings Tab -->
            <div id="settings-tab" class="tab-content p-6">
                <div class="flex items-center justify-between mb-6">
                    <div>
                        <h2 class="text-2xl font-bold text-white mb-2">System Settings</h2>
                        <p class="text-gray-400">Configure system behavior and integrations</p>
                    </div>
                </div>
                
                <div class="grid grid-cols-1 lg:grid-cols-2 xl:grid-cols-3 gap-6">
                    <!-- AI Model Selection -->
                    <div class="holographic-card rounded-lg p-6">
                        <h3 class="text-xl font-semibold text-white mb-4 flex items-center space-x-2">
                            <i data-lucide="brain" class="w-5 h-5 text-purple-400"></i>
                            <span>AI Model</span>
                        </h3>
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-300 mb-2">Current Model</label>
                                <div id="currentModelDisplay" class="bg-gray-800 border border-gray-600 rounded-lg px-3 py-2 text-white">
                                    <div class="flex items-center space-x-3">
                                        <div id="currentModelIcon" class="w-6 h-6 rounded-full bg-blue-500 flex items-center justify-center text-xs font-bold text-white">
                                            AI
                                        </div>
                                        <div>
                                            <div id="currentModelName" class="font-medium">Loading...</div>
                                            <div id="currentModelProvider" class="text-xs text-gray-400">Provider</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-300 mb-2">Select Model</label>
                                <select id="modelSelect" class="w-full bg-gray-800 border border-gray-600 rounded-lg px-3 py-2 text-white">
                                    <option value="">Loading models...</option>
                                </select>
                            </div>
                            <div id="modelInfo" class="bg-blue-500/10 border border-blue-500/20 rounded-lg p-3 hidden">
                                <div class="text-xs text-blue-300">
                                    <div class="grid grid-cols-2 gap-2 mb-2">
                                        <div>
                                            <span class="text-blue-200">Tools:</span>
                                            <span id="modelSupportsTools" class="font-medium">-</span>
                                        </div>
                                        <div>
                                            <span class="text-blue-200">VAD:</span>
                                            <span id="modelSupportsVAD" class="font-medium">-</span>
                                        </div>
                                    </div>
                                    <div>
                                        <span class="text-blue-200">Audio:</span>
                                        <span id="modelAudioFormat" class="font-medium">-</span>
                                    </div>
                                    <div id="modelSessionLimit" class="text-xs text-orange-300 mt-2 hidden">
                                        <i data-lucide="clock" class="w-3 h-3 inline mr-1"></i>
                                        <span>Session limit: <span id="modelLimitText">-</span> minutes</span>
                                    </div>
                                </div>
                            </div>
                            <button id="saveModelButton" class="w-full bg-purple-600 hover:bg-purple-700 text-white py-2 px-4 rounded-lg transition-colors flex items-center justify-center space-x-2 disabled:opacity-50 disabled:cursor-not-allowed">
                                <i data-lucide="save" class="w-4 h-4"></i>
                                <span>Update Model</span>
                            </button>
                        </div>
                    </div>

                    <div class="holographic-card rounded-lg p-6">
                        <h3 class="text-xl font-semibold text-white mb-4 flex items-center space-x-2">
                            <i data-lucide="phone" class="w-5 h-5 text-blue-400"></i>
                            <span>Voice Configuration</span>
                        </h3>
                        <div class="space-y-5">
                            <div>
                                <label class="block text-sm font-medium text-gray-300 mb-2">Voice Model</label>
                                <select id="voiceSelect" class="w-full bg-gray-800 border border-gray-600 rounded-lg px-3 py-2 text-white">
                                </select>
                                <p class="text-xs text-gray-400 mt-2">Default voice used when randomization is disabled.</p>
                            </div>

                            <div class="flex items-start justify-between bg-slate-900/60 border border-slate-700 rounded-lg px-4 py-3">
                                <div>
                                    <p class="text-sm font-medium text-gray-200">Randomize Voices</p>
                                    <p id="voicePoolDescription" class="text-xs text-gray-400">Rotates between cedar, marin, shimmer, and alloy.</p>
                                </div>
                                <label class="inline-flex items-center cursor-pointer">
                                    <input type="checkbox" id="randomizeVoicesToggle" class="sr-only peer">
                                    <div class="w-12 h-6 bg-gray-600 rounded-full peer peer-checked:bg-purple-500 transition-colors relative">
                                        <div class="absolute top-0.5 left-0.5 w-5 h-5 bg-white rounded-full transition-transform peer-checked:translate-x-6"></div>
                                    </div>
                                </label>
                            </div>

                            <div>
                                <div class="flex items-center justify-between mb-2">
                                    <label class="block text-sm font-medium text-gray-300">Speech Speed</label>
                                    <span id="speechSpeedDisplay" class="text-xs text-purple-300 font-semibold">1.10x</span>
                                </div>
                                <input type="range" id="speechSpeedInput" min="0.5" max="2" step="0.05" value="1.1" class="w-full accent-purple-400">
                                <p class="text-xs text-gray-400 mt-1">Higher values make the AI speak faster. Default is 1.10x.</p>
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-gray-300 mb-2">Input Format</label>
                                <div class="bg-gray-800 border border-gray-600 rounded-lg px-3 py-2 text-gray-400">
                                    G.711 Œº-law (8kHz)
                                </div>
                            </div>

                            <button id="saveVoiceButton" class="w-full bg-blue-600 hover:bg-blue-700 text-white py-2.5 rounded-lg font-semibold transition-colors flex items-center justify-center space-x-2 disabled:opacity-50 disabled:cursor-not-allowed">
                                <i data-lucide="waveform" class="w-4 h-4"></i>
                                <span>Apply Voice Settings</span>
                            </button>
                        </div>
                    </div>
                    
                    <div class="holographic-card rounded-lg p-6">
                        <h3 class="text-xl font-semibold text-white mb-4 flex items-center space-x-2">
                            <i data-lucide="database" class="w-5 h-5 text-green-400"></i>
                            <span>Storage & Recording</span>
                        </h3>
                        <div class="space-y-4">
                            <div class="flex items-center justify-between p-3 bg-green-500/10 rounded-lg">
                                <div class="flex items-center space-x-3">
                                    <i data-lucide="check-circle" class="w-5 h-5 text-green-400"></i>
                                    <span class="text-green-300">Call Recording</span>
                                </div>
                                <span class="text-sm text-green-400 font-medium">Enabled</span>
                            </div>
                            <div class="flex items-center justify-between p-3 bg-blue-500/10 rounded-lg">
                                <div class="flex items-center space-x-3">
                                    <i data-lucide="cloud" class="w-5 h-5 text-blue-400"></i>
                                    <span class="text-blue-300">Google Drive Backup</span>
                                </div>
                                <span id="driveStatus" class="text-sm font-medium">Unknown</span>
                            </div>
                            <a href="/recordings" class="block w-full bg-purple-600 hover:bg-purple-700 text-white text-center py-3 px-4 rounded-lg transition-colors">
                                <i data-lucide="headphones" class="w-4 h-4 inline mr-2"></i>
                                View Recordings
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Success/Error Messages -->
    <div id="messageContainer" class="fixed top-4 right-4 z-50"></div>

    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-50 hidden">
        <div class="holographic-card rounded-xl p-8 text-center">
            <div class="animate-spin rounded-full h-12 w-12 border-4 border-blue-500 border-t-transparent mx-auto mb-4"></div>
            <p class="text-white font-medium">Loading configuration...</p>
        </div>
    </div>

    <!-- Function Editor Modal -->
    <div id="functionEditorOverlay" class="fixed inset-0 bg-black/70 backdrop-blur-md flex items-center justify-center z-50 hidden">
        <div class="holographic-card rounded-2xl w-full max-w-3xl p-8 relative" onclick="event.stopPropagation()">
            <div class="flex items-start justify-between mb-6">
                <div>
                    <p class="text-sm text-blue-300 font-medium">Editing Function</p>
                    <h3 id="functionEditorTitle" class="text-2xl font-semibold text-white">Function Name</h3>
                </div>
                <button class="text-gray-400 hover:text-white transition" onclick="closeFunctionEditor()">
                    <i data-lucide="x" class="w-6 h-6"></i>
                </button>
            </div>

            <div class="space-y-5">
                <div>
                    <label for="functionDescriptionInput" class="text-sm font-medium text-gray-300 mb-2 block">Description</label>
                    <textarea id="functionDescriptionInput" class="w-full rounded-xl bg-white/5 border border-white/10 text-white p-4 focus:border-blue-400 focus:ring-2 focus:ring-blue-500/30 transition min-h-[90px]" placeholder="Describe what this function does"></textarea>
                </div>
                <div>
                    <div class="flex items-center justify-between mb-2">
                        <label for="functionParametersInput" class="text-sm font-medium text-gray-300">Parameters (JSON Schema)</label>
                        <span class="text-xs text-gray-400">Provide valid JSON describing the parameters object</span>
                    </div>
                    <textarea id="functionParametersInput" class="code-font w-full rounded-xl bg-black/60 border border-white/10 text-blue-100 p-4 focus:border-blue-400 focus:ring-2 focus:ring-blue-500/30 transition min-h-[240px]" spellcheck="false" placeholder='{ "type": "object", "properties": {} }'></textarea>
                </div>
                <p id="functionEditorError" class="text-sm text-red-300 bg-red-500/10 border border-red-500/30 rounded-lg px-3 py-2 hidden"></p>
            </div>

            <div class="mt-6 flex flex-wrap items-center justify-between gap-3">
                <button id="resetFunctionButton" class="text-sm text-red-300 hover:text-red-200 border border-red-500/40 rounded-lg px-4 py-2 transition" onclick="handleFunctionReset()">
                    Reset to default
                </button>
                <div class="flex items-center gap-3">
                    <button class="text-sm text-gray-300 hover:text-white border border-white/20 rounded-lg px-4 py-2 transition" onclick="closeFunctionEditor()">
                        Cancel
                    </button>
                    <button id="saveFunctionButton" class="text-sm bg-gradient-to-r from-blue-500 to-purple-500 text-white rounded-lg px-5 py-2.5 font-medium flex items-center gap-2 hover:opacity-90 transition" onclick="handleFunctionSave()">
                        <i data-lucide="save" class="w-4 h-4"></i>
                        Save Changes
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Initialize
        let editor;
        let menuEditor;
        let currentConfig = {};
        let currentFunctions = [];
        let activeFunction = null;
        let functionEditorBusy = false;
        let menuEditorBusy = false;
        let menuDataDefault = null;
        
        document.addEventListener('DOMContentLoaded', function() {
            lucide.createIcons();
            initializeEditor();
            initializeMenuEditor();
            loadConfiguration();
            setupEventListeners();
        });
        
        function initializeEditor() {
            editor = ace.edit("promptEditor");
            editor.setTheme("ace/theme/monokai");
            editor.session.setMode("ace/mode/text");
            editor.setOptions({
                fontSize: 14,
                showLineNumbers: true,
                showGutter: true,
                highlightActiveLine: true,
                wrap: true
            });
        }

        function initializeMenuEditor() {
            menuEditor = ace.edit("menuEditor");
            menuEditor.setTheme("ace/theme/tomorrow_night");
            menuEditor.session.setMode("ace/mode/json");
            menuEditor.setOptions({
                fontSize: 13,
                showLineNumbers: true,
                showGutter: true,
                highlightActiveLine: true,
                wrap: true,
            });
        }
        
        async function loadConfiguration() {
            const loadingOverlay = document.getElementById('loadingOverlay');
            loadingOverlay.classList.remove('hidden');
            
            try {
                const response = await fetch('/admin/config');
                const config = await response.json();
                config.defaultConfig = config.defaultConfig || {};
                currentConfig = config;
                
                // Update editor
                editor.setValue(config.systemPrompt || '');
                editor.clearSelection();
                
                // Update stats
                document.getElementById('functionsCount').textContent = config.functions?.length || 0;
                document.getElementById('promptLength').textContent = (config.systemPrompt || '').length;
                document.getElementById('lastUpdated').textContent = 'Just now';
                
                const voiceSelect = document.getElementById('voiceSelect');
                const randomizeToggle = document.getElementById('randomizeVoicesToggle');
                const speedInput = document.getElementById('speechSpeedInput');
                const speedDisplay = document.getElementById('speechSpeedDisplay');
                const poolDescription = document.getElementById('voicePoolDescription');

                if (Array.isArray(config.availableVoices) && config.availableVoices.length) {
                    populateVoiceOptions(config.availableVoices);
                }

                const currentVoice = config.currentVoice || config.defaultConfig.voice;
                if (voiceSelect && currentVoice) {
                    voiceSelect.value = currentVoice;
                }

                if (randomizeToggle) {
                    randomizeToggle.checked = !!config.voiceRandomizationEnabled;
                    toggleVoiceSelectAvailability();
                }

                const speedValue = typeof config.currentSpeed === 'number'
                    ? config.currentSpeed
                    : (config.defaultSpeed || config.defaultConfig.speed || 1.1);
                if (speedInput) {
                    speedInput.value = speedValue;
                }
                if (speedDisplay) {
                    speedDisplay.textContent = `${Number(speedValue).toFixed(2)}x`;
                }
                if (poolDescription) {
                    if (Array.isArray(config.randomVoicePool) && config.randomVoicePool.length) {
                        poolDescription.textContent = `Rotates between ${config.randomVoicePool.join(', ')}`;
                    } else {
                        poolDescription.textContent = 'Rotates between cedar, marin, shimmer, and alloy.';
                    }
                }
                
                // Load functions
                loadFunctions(config.functions || []);
                
                // Load AI models
                loadAIModels(config.currentModel, config.availableModels || []);

                await loadMenuDataEditor();
                
                // Update Google Drive status
                const driveStatus = document.getElementById('driveStatus');
                if (driveStatus) {
                    if (config.googleDriveEnabled) {
                        driveStatus.textContent = 'Enabled';
                        driveStatus.className = 'text-sm text-green-400 font-medium';
                    } else {
                        driveStatus.textContent = 'Disabled';
                        driveStatus.className = 'text-sm text-orange-400 font-medium';
                    }
                }
                
                showMessage('Configuration loaded successfully', 'success');
            } catch (error) {
                console.error('Failed to load configuration:', error);
                showMessage('Failed to load configuration', 'error');
            } finally {
                loadingOverlay.classList.add('hidden');
            }
        }
        
        function loadFunctions(functions) {
            currentFunctions = functions;
            const grid = document.getElementById('functionsGrid');
            grid.innerHTML = '';
            
            functions.forEach(func => {
                const card = document.createElement('div');
                card.className = 'function-card holographic-card rounded-lg p-6';
                card.addEventListener('click', () => openFunctionEditor(func));
                
                const requiredParams = func.parameters?.required || [];
                const allParams = Object.keys(func.parameters?.properties || {});
                const optionalParams = allParams.filter(p => !requiredParams.includes(p));
                
                card.innerHTML = `
                    <div class="flex items-start justify-between mb-4">
                        <div class="flex items-center space-x-3">
                            <div class="w-10 h-10 bg-gradient-to-br from-blue-500 to-purple-500 rounded-lg flex items-center justify-center">
                                <i data-lucide="zap" class="w-5 h-5 text-white"></i>
                            </div>
                            <div>
                                <h3 class="text-lg font-semibold text-white">${func.name}</h3>
                                <p class="text-xs text-blue-400 code-font">${func.type}</p>
                            </div>
                        </div>
                        <div class="bg-green-500/20 text-green-400 text-xs px-2 py-1 rounded-full">
                            Active
                        </div>
                    </div>
                    
                    <p class="text-gray-300 text-sm mb-4">${func.description || 'No description provided'}</p>
                    
                    <div class="space-y-3">
                        ${requiredParams.length > 0 ? `
                            <div>
                                <p class="text-xs font-medium text-red-400 mb-2">Required Parameters</p>
                                <div class="flex flex-wrap gap-1">
                                    ${requiredParams.map(param => `
                                        <span class="bg-red-500/20 text-red-300 text-xs px-2 py-1 rounded code-font">${param}</span>
                                    `).join('')}
                                </div>
                            </div>
                        ` : ''}
                        
                        ${optionalParams.length > 0 ? `
                            <div>
                                <p class="text-xs font-medium text-blue-400 mb-2">Optional Parameters</p>
                                <div class="flex flex-wrap gap-1">
                                    ${optionalParams.map(param => `
                                        <span class="bg-blue-500/20 text-blue-300 text-xs px-2 py-1 rounded code-font">${param}</span>
                                    `).join('')}
                                </div>
                            </div>
                        ` : ''}
                    </div>
                `;
                
                grid.appendChild(card);
            });
            
            lucide.createIcons();
        }

        async function loadMenuDataEditor() {
            if (!menuEditor) return;
            setMenuEditorBusy(true);
            try {
                const response = await fetch('/admin/menu');
                const data = await response.json();
                if (!response.ok || !data.menu) {
                    throw new Error(data.error || 'Failed to load menu data');
                }
                menuDataDefault = data.defaultMenu || null;
                const editorValue = JSON.stringify(data.menu || data.defaultMenu || {}, null, 2);
                menuEditor.setValue(editorValue);
                menuEditor.clearSelection();
                hideMenuEditorError();
            } catch (error) {
                console.error('Failed to load menu data:', error);
                showMenuEditorError(error.message || 'Failed to load menu data');
            } finally {
                setMenuEditorBusy(false);
            }
        }

        function openFunctionEditor(func) {
            const overlay = document.getElementById('functionEditorOverlay');
            if (!overlay) return;
            activeFunction = func;
            const descriptionInput = document.getElementById('functionDescriptionInput');
            const parametersInput = document.getElementById('functionParametersInput');
            const title = document.getElementById('functionEditorTitle');
            descriptionInput.value = func.description || '';
            try {
                parametersInput.value = JSON.stringify(func.parameters || {}, null, 2);
            } catch {
                parametersInput.value = '{\n  "type": "object"\n}';
            }
            title.textContent = func.name;
            hideFunctionEditorError();
            overlay.classList.remove('hidden');
            lucide.createIcons();
        }

        function closeFunctionEditor() {
            const overlay = document.getElementById('functionEditorOverlay');
            if (overlay) {
                overlay.classList.add('hidden');
            }
            activeFunction = null;
            setFunctionEditorBusy(false);
        }

        function showFunctionEditorError(message) {
            const el = document.getElementById('functionEditorError');
            if (!el) return;
            el.textContent = message;
            el.classList.remove('hidden');
        }

        function hideFunctionEditorError() {
            const el = document.getElementById('functionEditorError');
            if (!el) return;
            el.classList.add('hidden');
            el.textContent = '';
        }

        function setFunctionEditorBusy(isBusy) {
            functionEditorBusy = isBusy;
            const saveBtn = document.getElementById('saveFunctionButton');
            const resetBtn = document.getElementById('resetFunctionButton');
            if (saveBtn) {
                saveBtn.disabled = isBusy;
                saveBtn.classList.toggle('opacity-60', isBusy);
            }
            if (resetBtn) {
                resetBtn.disabled = isBusy;
                resetBtn.classList.toggle('opacity-60', isBusy);
            }
        }

        async function handleFunctionSave() {
            if (!activeFunction || functionEditorBusy) return;
            const descriptionInput = document.getElementById('functionDescriptionInput');
            const parametersInput = document.getElementById('functionParametersInput');
            let parsedParameters;
            try {
                parsedParameters = JSON.parse(parametersInput.value || '{}');
            } catch (error) {
                showFunctionEditorError('Parameters must be valid JSON. ' + error.message);
                return;
            }

            hideFunctionEditorError();
            setFunctionEditorBusy(true);
            try {
                const response = await fetch(`/admin/functions/${encodeURIComponent(activeFunction.name)}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        description: descriptionInput.value || '',
                        parameters: parsedParameters,
                    }),
                });
                const data = await response.json();
                if (!response.ok || !data.success) {
                    throw new Error(data.error || 'Failed to update function schema');
                }
                showMessage(`${activeFunction.name} updated`, 'success');
                closeFunctionEditor();
                await loadConfiguration();
            } catch (error) {
                console.error('Failed to update function schema:', error);
                showFunctionEditorError(error.message || 'Failed to update function schema');
            } finally {
                setFunctionEditorBusy(false);
            }
        }

        async function handleFunctionReset() {
            if (!activeFunction || functionEditorBusy) return;
            if (!confirm(`Reset ${activeFunction.name} to its default schema?`)) {
                return;
            }
            hideFunctionEditorError();
            setFunctionEditorBusy(true);
            try {
                const response = await fetch(`/admin/functions/${encodeURIComponent(activeFunction.name)}`, {
                    method: 'DELETE',
                });
                const data = await response.json();
                if (!response.ok || !data.success) {
                    throw new Error(data.error || 'Failed to reset function schema');
                }
                showMessage(`${activeFunction.name} reset to default`, 'success');
                closeFunctionEditor();
                await loadConfiguration();
            } catch (error) {
                console.error('Failed to reset function schema:', error);
                showFunctionEditorError(error.message || 'Failed to reset function schema');
            } finally {
                setFunctionEditorBusy(false);
            }
        }

        function showMenuEditorError(message) {
            const el = document.getElementById('menuEditorError');
            if (!el) return;
            el.textContent = message;
            el.classList.remove('hidden');
        }

        function hideMenuEditorError() {
            const el = document.getElementById('menuEditorError');
            if (!el) return;
            el.textContent = '';
            el.classList.add('hidden');
        }

        function setMenuEditorBusy(isBusy) {
            menuEditorBusy = isBusy;
            const saveBtn = document.getElementById('saveMenuButton');
            const resetBtn = document.getElementById('resetMenuButton');
            if (saveBtn) {
                saveBtn.disabled = isBusy;
                saveBtn.classList.toggle('opacity-60', isBusy);
            }
            if (resetBtn) {
                resetBtn.disabled = isBusy;
                resetBtn.classList.toggle('opacity-60', isBusy);
            }
        }

        async function saveMenuData() {
            if (menuEditorBusy || !menuEditor) return;
            hideMenuEditorError();
            let parsed;
            try {
                const raw = menuEditor.getValue();
                parsed = JSON.parse(raw);
            } catch (error) {
                showMenuEditorError(`Menu JSON invalid: ${error.message}`);
                return;
            }

            setMenuEditorBusy(true);
            try {
                const response = await fetch('/admin/menu', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ menu: parsed }),
                });
                const data = await response.json();
                if (!response.ok || !data.success) {
                    throw new Error(data.error || 'Failed to save menu data');
                }
                showMessage('Menu updated successfully', 'success');
                await loadMenuDataEditor();
            } catch (error) {
                console.error('Failed to save menu data:', error);
                showMenuEditorError(error.message || 'Failed to save menu data');
            } finally {
                setMenuEditorBusy(false);
            }
        }

        async function resetMenuDataToDefault() {
            if (menuEditorBusy) return;
            if (!confirm('Reset the menu to the default sample data? This will overwrite any custom changes.')) {
                return;
            }
            hideMenuEditorError();
            setMenuEditorBusy(true);
            try {
                const response = await fetch('/admin/menu', { method: 'DELETE' });
                const data = await response.json();
                if (!response.ok || !data.success) {
                    throw new Error(data.error || 'Failed to reset menu data');
                }
                showMessage('Menu reset to default', 'success');
                await loadMenuDataEditor();
            } catch (error) {
                console.error('Failed to reset menu data:', error);
                showMenuEditorError(error.message || 'Failed to reset menu data');
            } finally {
                setMenuEditorBusy(false);
            }
        }

        function populateVoiceOptions(voices) {
            if (!Array.isArray(voices) || voices.length === 0) return;
            const select = document.getElementById('voiceSelect');
            if (!select) return;

            const labels = {
                alloy: 'Alloy',
                ash: 'Ash',
                ballad: 'Ballad',
                coral: 'Coral',
                echo: 'Echo',
                sage: 'Sage',
                shimmer: 'Shimmer',
                verse: 'Verse',
                marin: 'Marin',
                cedar: 'Cedar'
            };

            select.innerHTML = '';

            voices.forEach((voice) => {
                const option = document.createElement('option');
                option.value = voice;
                option.textContent = labels[voice] || voice.charAt(0).toUpperCase() + voice.slice(1);
                select.appendChild(option);
            });

            const desiredVoice = (currentConfig.defaultConfig && voices.includes(currentConfig.defaultConfig.voice))
                ? currentConfig.defaultConfig.voice
                : voices[0];

            select.value = desiredVoice;
        }

        function toggleVoiceSelectAvailability() {
            const randomizeToggle = document.getElementById('randomizeVoicesToggle');
            const select = document.getElementById('voiceSelect');
            if (!select || !randomizeToggle) return;
            select.disabled = randomizeToggle.checked;
            select.classList.toggle('opacity-60', randomizeToggle.checked);
        }

        function updateSpeedDisplay() {
            const input = document.getElementById('speechSpeedInput');
            const label = document.getElementById('speechSpeedDisplay');
            if (!input || !label) return;
            const value = parseFloat(input.value) || 1.1;
            label.textContent = `${value.toFixed(2)}x`;
        }
        
        function setupEventListeners() {
            // Tab switching
            document.querySelectorAll('.tab-button').forEach(button => {
                button.addEventListener('click', () => {
                    const tabId = button.getAttribute('data-tab');
                    switchTab(tabId, button);
                });
            });
            
            // Save prompt button
            document.getElementById('savePromptButton').addEventListener('click', savePrompt);
            
            // Reset prompt button
            document.getElementById('resetPromptButton').addEventListener('click', resetPrompt);
            
            // Editor change tracking
            editor.on('change', () => {
                const length = editor.getValue().length;
                document.getElementById('promptLength').textContent = length;
            });
            
            // Model selection change
            document.getElementById('modelSelect').addEventListener('change', (e) => {
                const selectedModelId = e.target.value;
                if (selectedModelId && currentConfig.availableModels) {
                    const selectedModel = currentConfig.availableModels.find(m => m.id === selectedModelId);
                    updateModelInfo(selectedModel);
                }
            });
            
            // Save model button
            document.getElementById('saveModelButton').addEventListener('click', saveModel);

            const voiceSelect = document.getElementById('voiceSelect');
            const randomizeToggle = document.getElementById('randomizeVoicesToggle');
            const speedInput = document.getElementById('speechSpeedInput');
            const saveVoiceButton = document.getElementById('saveVoiceButton');

            if (voiceSelect) {
                voiceSelect.addEventListener('change', () => {
                    currentConfig.defaultConfig = currentConfig.defaultConfig || {};
                    currentConfig.defaultConfig.voice = voiceSelect.value;
                });
            }

            if (randomizeToggle) {
                randomizeToggle.addEventListener('change', () => {
                    toggleVoiceSelectAvailability();
                });
            }

            if (speedInput) {
                speedInput.addEventListener('input', updateSpeedDisplay);
            }

            if (saveVoiceButton) {
                saveVoiceButton.addEventListener('click', updateVoice);
            }

            const functionOverlay = document.getElementById('functionEditorOverlay');
            if (functionOverlay) {
                functionOverlay.addEventListener('click', (event) => {
                    if (event.target === functionOverlay) {
                        closeFunctionEditor();
                    }
                });
            }

            const saveMenuBtn = document.getElementById('saveMenuButton');
            if (saveMenuBtn) {
                saveMenuBtn.addEventListener('click', saveMenuData);
            }
            const resetMenuBtn = document.getElementById('resetMenuButton');
            if (resetMenuBtn) {
                resetMenuBtn.addEventListener('click', resetMenuDataToDefault);
            }
        }
        
        function switchTab(tabId, button) {
            // Update buttons
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.classList.remove('active');
                btn.classList.add('text-gray-400', 'hover:text-gray-300');
            });
            button.classList.add('active');
            button.classList.remove('text-gray-400', 'hover:text-gray-300');
            
            // Update content
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            document.getElementById(tabId).classList.add('active');
        }
        
        async function savePrompt() {
            const button = document.getElementById('savePromptButton');
            const originalText = button.innerHTML;
            
            button.innerHTML = `
                <div class="animate-spin rounded-full h-4 w-4 border-2 border-white border-t-transparent mr-2"></div>
                Saving...
            `;
            button.disabled = true;
            
            try {
                const response = await fetch('/admin/config/prompt', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        systemPrompt: editor.getValue()
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    document.getElementById('lastUpdated').textContent = new Date().toLocaleTimeString();
                    showMessage('System prompt saved successfully', 'success');
                } else {
                    throw new Error(data.error || 'Failed to save prompt');
                }
            } catch (error) {
                console.error('Failed to save prompt:', error);
                showMessage('Failed to save prompt', 'error');
            } finally {
                button.innerHTML = originalText;
                button.disabled = false;
            }
        }
        
        function resetPrompt() {
            if (confirm('Are you sure you want to reset to the default system prompt? This will overwrite your current changes.')) {
                if (currentConfig.defaultConfig?.instructions) {
                    editor.setValue(currentConfig.defaultConfig.instructions);
                    editor.clearSelection();
                    showMessage('Prompt reset to default', 'info');
                }
            }
        }
        
        function loadAIModels(currentModel, availableModels) {
            // Update current model display
            if (currentModel) {
                updateCurrentModelDisplay(currentModel);
                document.getElementById('voiceModel').textContent = currentModel.name;
            }
            
            // Populate model selector
            const select = document.getElementById('modelSelect');
            select.innerHTML = '';
            
            if (availableModels.length === 0) {
                select.innerHTML = '<option value="">No models available</option>';
                select.disabled = true;
                return;
            }
            
            // Group models by provider
            const providers = {};
            availableModels.forEach(model => {
                if (!providers[model.provider]) {
                    providers[model.provider] = [];
                }
                providers[model.provider].push(model);
            });
            
            // Add options grouped by provider
            Object.keys(providers).forEach(provider => {
                const optgroup = document.createElement('optgroup');
                optgroup.label = provider.charAt(0).toUpperCase() + provider.slice(1);
                
                providers[provider].forEach(model => {
                    const option = document.createElement('option');
                    option.value = model.id;
                    option.textContent = model.name;
                    option.selected = currentModel && model.id === currentModel.id;
                    optgroup.appendChild(option);
                });
                
                select.appendChild(optgroup);
            });
            
            select.disabled = false;
        }
        
        function updateCurrentModelDisplay(model) {
            // Update icon based on provider
            const icon = document.getElementById('currentModelIcon');
            const name = document.getElementById('currentModelName');
            const provider = document.getElementById('currentModelProvider');
            
            icon.textContent = 'AI';
            icon.className = 'w-6 h-6 rounded-full bg-green-500 flex items-center justify-center text-xs font-bold text-white';
            
            name.textContent = model.name;
            provider.textContent = model.provider.charAt(0).toUpperCase() + model.provider.slice(1);
        }
        
        function updateModelInfo(model) {
            if (!model) {
                document.getElementById('modelInfo').classList.add('hidden');
                return;
            }
            
            document.getElementById('modelSupportsTools').textContent = model.supportsTools ? 'Yes' : 'No';
            document.getElementById('modelSupportsVAD').textContent = model.supportsVAD ? 'Yes' : 'No';
            document.getElementById('modelAudioFormat').textContent = model.audioFormat?.input || 'Unknown';
            
            const limitElement = document.getElementById('modelSessionLimit');
            const limitText = document.getElementById('modelLimitText');
            
            if (model.maxSessionDuration) {
                limitText.textContent = model.maxSessionDuration;
                limitElement.classList.remove('hidden');
            } else {
                limitElement.classList.add('hidden');
            }
            
            document.getElementById('modelInfo').classList.remove('hidden');
        }
        
        async function saveModel() {
            const select = document.getElementById('modelSelect');
            const button = document.getElementById('saveModelButton');
            const originalText = button.innerHTML;
            
            if (!select.value) {
                showMessage('Please select a model', 'error');
                return;
            }
            
            button.innerHTML = `
                <div class="animate-spin rounded-full h-4 w-4 border-2 border-white border-t-transparent mr-2"></div>
                Updating...
            `;
            button.disabled = true;
            
            try {
                const response = await fetch('/admin/config/model', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        modelId: select.value
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    updateCurrentModelDisplay(data.currentModel);
                    document.getElementById('voiceModel').textContent = data.currentModel.name;
                    document.getElementById('lastUpdated').textContent = new Date().toLocaleTimeString();
                    showMessage(data.message, 'success');
                } else {
                    throw new Error(data.error || 'Failed to update model');
                }
            } catch (error) {
                console.error('Failed to update model:', error);
                showMessage('Failed to update model', 'error');
            } finally {
                button.innerHTML = originalText;
                button.disabled = false;
            }
        }

        async function updateVoice() {
            const select = document.getElementById('voiceSelect');
            const randomizeToggle = document.getElementById('randomizeVoicesToggle');
            const speedInput = document.getElementById('speechSpeedInput');
            const speedDisplay = document.getElementById('speechSpeedDisplay');
            const saveButton = document.getElementById('saveVoiceButton');

            if (!randomizeToggle || !speedInput || !saveButton) return;

            const randomizeVoices = randomizeToggle.checked;
            const voice = select ? select.value : '';
            const speed = parseFloat(speedInput.value) || 1.1;

            if (!randomizeVoices && !voice) {
                showMessage('Select a voice or enable randomization.', 'error');
                return;
            }

            const payload = {
                randomizeVoices,
                speed,
                ...(randomizeVoices ? {} : { voice })
            };

            const originalContent = saveButton.innerHTML;
            saveButton.innerHTML = `
                <svg class="w-4 h-4 animate-spin text-white" viewBox="0 0 24 24" fill="none">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v4l3-3-3-3v4A8 8 0 104 12z"></path>
                </svg>
                <span>Applying...</span>
            `;
            saveButton.disabled = true;

            try {
                const response = await fetch('/admin/config/voice', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(payload)
                });

                const data = await response.json();

                if (!data.success) {
                    throw new Error(data.error || 'Failed to update voice');
                }

                currentConfig.voiceRandomizationEnabled = !!data.randomizeVoices;
                currentConfig.currentSpeed = data.speed || speed;
                currentConfig.randomVoicePool = data.randomVoicePool || currentConfig.randomVoicePool || [];
                currentConfig.currentVoice = data.voice || voice;
                currentConfig.defaultConfig = currentConfig.defaultConfig || {};
                currentConfig.defaultConfig.voice = currentConfig.currentVoice;

                if (select && data.voice) {
                    select.value = data.voice;
                }
                if (speedDisplay) {
                    speedDisplay.textContent = `${(data.speed || speed).toFixed(2)}x`;
                }
                if (data.randomVoicePool && data.randomVoicePool.length) {
                    const desc = document.getElementById('voicePoolDescription');
                    if (desc) {
                        desc.textContent = `Rotates between ${data.randomVoicePool.join(', ')}`;
                    }
                }

                toggleVoiceSelectAvailability();
                showMessage(data.message || 'Voice configuration updated', 'success');
            } catch (error) {
                console.error('Failed to update voice:', error);
                showMessage(error.message || 'Failed to update voice', 'error');
            } finally {
                saveButton.innerHTML = originalContent;
                saveButton.disabled = false;
            }
        }

        function showMessage(text, type = 'info') {
            const container = document.getElementById('messageContainer');
            const messageId = 'message-' + Date.now();
            
            const colors = {
                success: 'bg-green-500/20 border-green-500 text-green-100',
                error: 'bg-red-500/20 border-red-500 text-red-100',
                info: 'bg-blue-500/20 border-blue-500 text-blue-100'
            };
            
            const icons = {
                success: 'check-circle',
                error: 'alert-circle',
                info: 'info'
            };
            
            const message = document.createElement('div');
            message.id = messageId;
            message.className = `${colors[type]} border rounded-lg p-4 mb-3 flex items-center space-x-3 transform translate-x-full transition-transform duration-300`;
            message.innerHTML = `
                <i data-lucide="${icons[type]}" class="w-5 h-5"></i>
                <span>${text}</span>
                <button onclick="document.getElementById('${messageId}').remove()" class="ml-auto">
                    <i data-lucide="x" class="w-4 h-4"></i>
                </button>
            `;
            
            container.appendChild(message);
            lucide.createIcons();
            
            // Animate in
            setTimeout(() => {
                message.classList.remove('translate-x-full');
            }, 100);
            
            // Auto remove after 5 seconds
            setTimeout(() => {
                if (document.getElementById(messageId)) {
                    message.classList.add('translate-x-full');
                    setTimeout(() => message.remove(), 300);
                }
            }, 5000);
        }
    </script>
</body>
</html>
